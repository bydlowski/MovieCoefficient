<section>
	<h1>Coeficient</h1>
</section>
<section>
	<div class="row">

	  <div class="small-12 large-2 columns">
		  <% if user_signed_in? %>
			  <div>IMDB: <%= current_user.imdb_rating %></div>
			  <div>TMDB: <%= current_user.tmdb_rating %></div>
			  <div>Rotten: <%= current_user.rotten_rating %></div>
			  <div>Metacritic: <%= current_user.metacritic_rating %></div>
			  <div>Movies rated: <%= current_user.amount %></div>
			  <br />
			  <div>This guy: <%= @current_user %></div>
			  <br />
			  <div>
					<%= button_to "Reset", reset_path, data: { confirm: "Are you sure?" }, method: :update %>
				</div>
			<% end %>
		</div>
	  <div class="small-12 large-10 columns">
	  	<input id="countries" name="movie" placeholder="Enter a movie" />
	  	<br />
			<div id="the_form">
				<%= form_for('result_path', method: 'put', action: 'update', remote: true) do |f| %>
				  <%= f.label :user_rating, "Current Value = 5" %><br>
				  <%= f.range_field :user_rating, min: 0, max: 10, step: 0.1, class:'a', id: 'textSubmit' %>
				  <%= f.hidden_field :form_imdb_rating, id: 'form_imdb_rating' %>
				  <%= f.hidden_field :form_rotten_rating, id: 'form_rotten_rating' %>
				  <%= f.hidden_field :form_tmdb_rating, id: 'form_tmdb_rating' %>
				  <%= f.hidden_field :form_metacritic_rating, id: 'form_metacritic_rating' %>
				  <%= f.submit "Submit", id: 'resultSubmit' %>
				<% end %>
			</div>
	  </div>

	</div>

<div id="result"></div>
</section>

<script type="text/javascript">
	var input = document.getElementById("countries");
	var awesomplete = new Awesomplete(input, {
	  minChars: 3,
	  autoFirst: true
	});

	$("input").on("keyup", function(){
	  $.ajax({
	    url: 'http://api.themoviedb.org/3/search/movie?query=' + this.value + '&api_key=0b56c7e05825db6e3182d1aa00d47307',
	    //url: 'http://www.omdbapi.com/?type=movie&s=' + this.value,
	    type: 'GET',
	    dataType: 'json'
	  })
	  .success(function(data) {
	    var list = [];
	    $.each(data['results'], function(key, info) {
	      var year = info[('release_date')].substring(0,4);
	      //list.push(value['title'] + ' (' + year + ')' );
	      list.push({label: info['title'] + ' (' + year + ')', value: info['title'] + ' (' + year + ')', extra: info['vote_average']});
	    });
	    awesomplete.list = list;
	  });
	});

	Awesomplete.$.bind(input, {
	  "awesomplete-select": function(evt) {
	    var chosenMovie = evt.text['value']
	    var ratingTMDB = evt.text['extra'];
	    var movieNameWithSpaces = chosenMovie.substr(0, chosenMovie.indexOf(' ('));
	    var movieName = movieNameWithSpaces.split(' ').join('+')
	    var movieYear = (chosenMovie.substr(chosenMovie.length - 5)).match(/\d+/)[0];
	    $.ajax('http://www.omdbapi.com/?t=' + movieName + '&y=' + movieYear + '&type=movie&tomatoes=true', {
	        complete: function(p_oXHR, p_sStatus){
	            oData = $.parseJSON(p_oXHR.responseText);
	            ratingIMDB = Number(oData.imdbRating);
	            ratingRotten = Number(oData.tomatoRating);
	            preRatingMetacritic = Number(oData.Metascore);
	            ratingMetacritic = parseFloat(preRatingMetacritic) / 10;
	            $('#form_imdb_rating').val(ratingIMDB);
	            $('#form_rotten_rating').val(ratingRotten);
	            $('#form_tmdb_rating').val(ratingTMDB);
	            $('#form_metacritic_rating').val(ratingMetacritic);
	        }
	    });
	  }
	});
</script>